{% extends "base.html" %}

{% block title %}BRP Dashboard - VEDA{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="static/css/brp.css">
  <style>
    /* FIX: Push content down */
    .page-content {
        max-width: 1200px;
        margin: 0 auto;
        margin-top: 90px; /* Added top margin */
        padding: 20px;
    }

    /* Dashboard specific layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 2fr; 
      gap: 20px;
      margin-top: 20px;
    }
    
    .control-panel {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      height: fit-content;
    }

    .charts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .chart-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      min-height: 300px;
    }

    select {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-top: 5px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #EDF5E1;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 5px solid #379683;
    }
    .stat-number { font-size: 24px; font-weight: bold; color: #05386B; }
    .stat-label { font-size: 14px; color: #555; }

    /* UNIFIED WELCOME BLOCK STYLE */
    .welcome-section {
        background-color: white;
        padding: 20px 25px;
        border-radius: 10px;
        margin-bottom: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border-left: 5px solid #5CDB95;
    }
    .welcome-text h2 {
        margin: 0;
        color: #05386B;
        font-size: 26px;
        font-family: 'Poppins', sans-serif;
    }
    .welcome-text p {
        margin: 5px 0 0;
        color: #888;
        font-size: 14px;
    }
    .profile-shortcut {
         text-decoration: none;
         transition: transform 0.2s;
         display: block;
    }
    .profile-shortcut:hover {
         transform: scale(1.05);
    }
    .user-avatar-large {
         width: 55px; 
         height: 55px; 
         background: #05386B; 
         color: #5CDB95; 
         border-radius: 50%; 
         display: flex; 
         align-items: center; 
         justify-content: center; 
         font-weight: 700; 
         font-size: 24px; 
         border: 3px solid #EDF5E1;
         box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
  </style>
{% endblock %}

{% block content %}

  <div class="page-content">
   
    <div class="welcome-section">
        <div class="welcome-text">
            <h2>Welcome, {{ user.name }}</h2>
            <p>Virtual Educator And Digital Assistant</p>
        </div>
        
        {% if user %}
        <a href="/profile" class="profile-shortcut" title="Open My Profile">
            <div class="user-avatar-large">
              {{ user.name[0] | upper }}
            </div>
        </a>
        {% endif %}
    </div>

    <div class="section-title">BRP Dashboard</div>

    <div class="dashboard-grid">
        
        <div class="control-panel">
            <h3>ðŸ‘¥ Track CRP Activity</h3>
            <p style="color:#666; font-size:0.9em;">Select a Cluster Resource Person (CRP) to view their performance and teacher support activities.</p>
            
            <label style="font-weight:600; color:#05386B;">Select CRP:</label>
            <select id="crpSelect" onchange="fetchCrpStats()">
                <option value="" disabled selected>-- Choose a CRP --</option>
                {% for crp in crps %}
                    <option value="{{ crp.employee_id }}">{{ crp.name }} ({{ crp.assigned_cluster }})</option>
                {% endfor %}
            </select>

            <div id="quickStats" style="display:none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalActions">0</div>
                    <div class="stat-label">Total Support Actions</div>
                </div>
            </div>
            
            <hr>
        </div>

        <div class="charts-container">
            <div class="chart-box">
                <h4 style="text-align:center; color:#05386B;">Support Breakdown</h4>
                <canvas id="breakdownChart"></canvas>
            </div>

            <div class="chart-box">
                <h4 style="text-align:center; color:#05386B;">Activity Comparison</h4>
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>

    </div>

  </div>

{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    let breakdownChartInstance = null;
    let comparisonChartInstance = null;

    async function fetchCrpStats() {
        const crpId = document.getElementById('crpSelect').value;
        if(!crpId) return;

        try {
            const response = await fetch(`/api/brp/crp-stats/${crpId}`);
            const result = await response.json();
            
            if(result.status === 'success') {
                updateDashboard(result.data);
            }
        } catch(error) {
            console.error("Error fetching CRP stats:", error);
        }
    }

    function updateDashboard(data) {
        document.getElementById('quickStats').style.display = 'block';
        document.getElementById('totalActions').textContent = data.total_actions;
        renderCharts(data.guidance, data.visits, data.resolved);
    }

    function renderCharts(guidance, visits, resolved) {
        const ctx1 = document.getElementById('breakdownChart').getContext('2d');
        const ctx2 = document.getElementById('comparisonChart').getContext('2d');

        if(breakdownChartInstance) breakdownChartInstance.destroy();
        if(comparisonChartInstance) comparisonChartInstance.destroy();

        breakdownChartInstance = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['Guidance', 'Visits', 'Resolved Issues'],
                datasets: [{
                    data: [guidance, visits, resolved],
                    backgroundColor: ['#379683', '#05386B', '#5CDB95'],
                    borderWidth: 1
                }]
            },
            options: { responsive: true }
        });

        comparisonChartInstance = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['Guidance', 'Visits', 'Resolved'],
                datasets: [{
                    label: 'Count',
                    data: [guidance, visits, resolved],
                    backgroundColor: ['#5CDB95', '#8EE4AF', '#379683'],
                    borderColor: '#05386B',
                    borderWidth: 1
                }]
            },
            options: {
                scales: { y: { beginAtZero: true, suggestedMax: 5 } },
                plugins: { legend: { display: false } }
            }
        });
    }
  </script>
{% endblock %}