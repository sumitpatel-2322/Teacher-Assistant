{% extends "base.html" %}

{% block title %}BRP Dashboard - VEDA{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="static/css/brp.css">
  <style>
    /* Dashboard specific layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 2fr; /* Sidebar for selection, Main for charts */
      gap: 20px;
      margin-top: 20px;
    }
    
    .control-panel {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      height: fit-content;
    }

    .charts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .chart-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      min-height: 300px;
    }

    select {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-top: 5px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #EDF5E1;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 5px solid #379683;
    }
    .stat-number { font-size: 24px; font-weight: bold; color: #05386B; }
    .stat-label { font-size: 14px; color: #555; }
  </style>
{% endblock %}

{% block content %}



  <div class="page-content">
   

    <header>
      <div class="header-left">
        <img src="static/img/logo.png" alt="BRP">
        <div>
          <div class="title">Welcome, {{ user.name }}</div>
          <div class="subtitle">Virtual Educator And Digital Assistant</div>
        </div>
      </div>

      <div class="header-right">
        {% if user %}
        <a href="/profile" style="text-decoration:none;">
          <div style="width: 40px; height: 40px; background: #5CDB95; color: #05386B; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; border: 2px solid #fff;">
            {{ user.name[0] | upper }}
          </div>
        </a>
        {% endif %}
      </div>
    </header>

    <div class="section-title">BRP Dashboard</div>

    <div class="dashboard-grid">
        
        <div class="control-panel">
            <h3>ðŸ‘¥ Track CRP Activity</h3>
            <p style="color:#666; font-size:0.9em;">Select a Cluster Resource Person (CRP) to view their performance and teacher support activities.</p>
            
            <label style="font-weight:600; color:#05386B;">Select CRP:</label>
            <select id="crpSelect" onchange="fetchCrpStats()">
                <option value="" disabled selected>-- Choose a CRP --</option>
                {% for crp in crps %}
                    <option value="{{ crp.employee_id }}">{{ crp.name }} ({{ crp.assigned_cluster }})</option>
                {% endfor %}
            </select>

            <div id="quickStats" style="display:none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalActions">0</div>
                    <div class="stat-label">Total Support Actions</div>
                </div>
            </div>
            
            <hr>
            </div>

        <div class="charts-container">
            <div class="chart-box">
                <h4 style="text-align:center; color:#05386B;">Support Breakdown</h4>
                <canvas id="breakdownChart"></canvas>
            </div>

            <div class="chart-box">
                <h4 style="text-align:center; color:#05386B;">Activity Comparison</h4>
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>

    </div>

  </div>


{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    let breakdownChartInstance = null;
    let comparisonChartInstance = null;

    async function fetchCrpStats() {
        const crpId = document.getElementById('crpSelect').value;
        if(!crpId) return;

        try {
            const response = await fetch(`/api/brp/crp-stats/${crpId}`);
            const result = await response.json();
            
            if(result.status === 'success') {
                updateDashboard(result.data);
            }
        } catch(error) {
            console.error("Error fetching CRP stats:", error);
        }
    }

    function updateDashboard(data) {
        // 1. Update Text Stats
        document.getElementById('quickStats').style.display = 'block';
        document.getElementById('totalActions').textContent = data.total_actions;

        // 2. Update Charts
        renderCharts(data.guidance, data.visits);
    }

    function renderCharts(guidance, visits) {
        const ctx1 = document.getElementById('breakdownChart').getContext('2d');
        const ctx2 = document.getElementById('comparisonChart').getContext('2d');

        // Destroy old charts if they exist
        if(breakdownChartInstance) breakdownChartInstance.destroy();
        if(comparisonChartInstance) comparisonChartInstance.destroy();

        // CHART 1: PIE CHART
        breakdownChartInstance = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['Guidance Notices', 'School Visits'],
                datasets: [{
                    data: [guidance, visits],
                    backgroundColor: ['#379683', '#05386B'],
                    borderWidth: 1
                }]
            },
            options: { responsive: true }
        });

        // CHART 2: BAR CHART
        comparisonChartInstance = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['Guidance', 'Visits'],
                datasets: [{
                    label: 'Count',
                    data: [guidance, visits],
                    backgroundColor: ['#5CDB95', '#8EE4AF'],
                    borderColor: '#05386B',
                    borderWidth: 1
                }]
            },
            options: {
                scales: { y: { beginAtZero: true, suggestedMax: 5 } },
                plugins: { legend: { display: false } }
            }
        });
    }
  </script>
{% endblock %}