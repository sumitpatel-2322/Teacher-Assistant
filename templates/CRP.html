{% extends "base.html" %}

{% block title %}CRP Dashboard - VEDA{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="static/css/crp.css">
  <style>
      /* FIX: Push content down so it's not hidden behind the Navbar */
      .page-container {
          max-width: 1200px;
          margin: 0 auto;
          margin-top: 90px; /* Added top margin */
          padding: 20px;
      }

      .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; }
      .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
      .data-table th { background-color: #05386B; color: white; }
      .tag { padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white; }
      .tag-open { background-color: #e74c3c; }
      .tag-resolved { background-color: #27ae60; }
      
      .btn-close-ticket {
          background: none;
          border: 1px solid #27ae60;
          color: #27ae60;
          cursor: pointer;
          border-radius: 4px;
          padding: 2px 6px;
          margin-left: 8px;
          transition: all 0.2s;
      }
      .btn-close-ticket:hover {
          background: #27ae60;
          color: white;
      }

      /* Unified Welcome Block */
      .welcome-section {
        background-color: white;
        padding: 20px 25px;
        border-radius: 10px;
        margin-bottom: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border-left: 5px solid #5CDB95;
      }
      .welcome-text h2 {
        margin: 0;
        color: #05386B;
        font-size: 26px;
        font-family: 'Poppins', sans-serif;
      }
      .welcome-text p {
        margin: 5px 0 0;
        color: #888;
        font-size: 14px;
      }
      .profile-shortcut {
         text-decoration: none;
         transition: transform 0.2s;
         display: block;
      }
      .profile-shortcut:hover {
         transform: scale(1.05);
      }
      .user-avatar-large {
         width: 55px; 
         height: 55px; 
         background: #05386B; 
         color: #5CDB95; 
         border-radius: 50%; 
         display: flex; 
         align-items: center; 
         justify-content: center; 
         font-weight: 700; 
         font-size: 24px; 
         border: 3px solid #EDF5E1;
         box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
  </style>
{% endblock %}

{% block content %}

  <div class="page-container">

    <div class="welcome-section">
        <div class="welcome-text">
            <h2>Welcome, {{ user.name }}</h2>
            <p>Virtual Educator And Digital Assistant</p>
        </div>
        
        {% if user %}
        <a href="/profile" class="profile-shortcut" title="Open My Profile">
            <div class="user-avatar-large">
              {{ user.name[0] | upper }}
            </div>
        </a>
        {% endif %}
    </div>

    <div class="section-title">Select School</div>
    <div class="teacher-dropdown-wrapper">
      <select id="teacherDropdown">
        <option value="">Select a School</option>
        {% for s in schools %}
          <option value="{{ s.udise }}">{{ s.name }} ({{ s.udise }})</option>
        {% endfor %}
      </select>
    </div>

    <div class="section-title">CRP Actions</div>
    <div class="actions">
      <button onclick="document.getElementById('visitModal').style.display='none'; document.getElementById('uploadModal').style.display='flex';">
        Upload Guidance
      </button>

      <button onclick="document.getElementById('uploadModal').style.display='none'; document.getElementById('visitModal').style.display='flex';">
        Schedule Visit
      </button>
    </div>

    <div class="section-title">Teacher Performance Overview</div>
    <div class="charts-grid">
      <div class="chart-card small">
        <h4 style="text-align:center; color:#05386B; margin-bottom:10px;">Success Rate</h4>
        <canvas id="completionDonut"></canvas>
      </div>
      <div class="chart-card wide">
        <h4 style="text-align:center; color:#05386B; margin-bottom:10px;">Top Problem Areas</h4>
        <canvas id="teacherHistogram"></canvas>
      </div>
    </div>
    <br>

    <div class="section-title">ðŸ›‘ Help Requests (Escalations)</div>
    <div style="overflow-x:auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Teacher</th>
                    <th>School</th>
                    <th>Query</th>
                    <th>Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% if escalations %}
                    {% for esc in escalations %}
                    <tr>
                        <td>{{ esc.teacher_name }}</td>
                        <td>{{ esc.school_name if esc.school_name else esc.school_id }}</td>
                        <td>{{ esc.query_text }}</td>
                        <td>{{ esc.created_at }}</td>
                        <td style="display: flex; align-items: center;">
                            {% if esc.status == 'Open' %}
                                <span class="tag tag-open">{{ esc.status }}</span>
                                <form action="/crp/close-escalation" method="POST" style="margin:0;">
                                    <input type="hidden" name="escalation_id" value="{{ esc.id }}">
                                    <button type="submit" class="btn-close-ticket" title="Mark as Resolved">
                                        âœ” Close
                                    </button>
                                </form>
                            {% else %}
                                <span class="tag tag-resolved">{{ esc.status }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="5" style="text-align:center;">No requests found for your block.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="section-title">ðŸ“‰ Detailed Problem Areas (Logs)</div>
    <div style="overflow-x:auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Teacher</th>
                    <th>Original Query</th>
                    <th>Solution Shown</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% if insights %}
                    {% for ins in insights %}
                    <tr>
                        <td>{{ ins.teacher_name }}</td>
                        <td>{{ ins.query_text }}</td>
                        <td>{{ ins.solution_shown }}</td>
                        <td>{{ ins.created_at }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="4" style="text-align:center;">No reported issues.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

  </div>

<div id="uploadModal" class="upload-modal" style="display:none;">
  <div class="upload-card">
    <h3>Upload Guidance</h3>
    <form action="/crp/upload-guidance" method="POST">
      <label class="modal-label">Select School</label>
      <select name="school_id" required>
        <option value="">Select School</option>
        {% for s in schools %}
          <option value="{{ s.udise }}">{{ s.name }}</option>
        {% endfor %}
      </select>
      <label class="modal-label">Title</label>
      <input type="text" name="title" required>
      <label class="modal-label">Description</label>
      <textarea name="description" rows="3" required></textarea>
      <div class="upload-actions">
        <button type="button" onclick="document.getElementById('uploadModal').style.display='none'">Cancel</button>
        <button type="submit">Upload</button>
      </div>
    </form>
  </div>
</div>

<div id="visitModal" class="upload-modal" style="display:none;">
  <div class="upload-card">
    <h3>Schedule Visit</h3>
    <form action="/crp/schedule-visit" method="POST">
      <label class="modal-label">Select School</label>
      <select name="school_id" required>
        <option value="">Select School</option>
        {% for s in schools %}
          <option value="{{ s.udise }}">{{ s.name }}</option>
        {% endfor %}
      </select>
      <label class="modal-label">Select Date</label>
      <input type="date" name="visit_date" required>
      <label class="modal-label">Select Time</label>
      <input type="time" name="visit_time" required>
      <div class="upload-actions">
        <button type="button" onclick="document.getElementById('visitModal').style.display='none'">Cancel</button>
        <button type="submit">Schedule</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/static/js/crp.js"></script>
{% endblock %}